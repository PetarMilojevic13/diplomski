<div class="film-details-wrapper">
  <div class="film-details-container">

  <!-- Loading State -->
    @if (loading) {
      <div class="loading">
    <div class="spinner"></div>
        <p>UÄitavanje...</p>
  </div>
    }

  <!-- Error State -->
    @if (error && !loading) {
      <div class="error-message">
        <h2>ğŸ˜• {{ error }}</h2>
        <button class="btn-back" (click)="goBack()">â† Nazad na katalog</button>
  </div>
    }

  <!-- Film Details -->
    @if (film && !loading && !error) {
      <div class="film-content">

    <!-- Back Button -->
        <button class="btn-back" (click)="goBack()">â† Nazad na katalog</button>

        <!-- Film Header -->
      <div class="film-header">
          <div class="film-poster-large">
            <img [src]="film.poster" [alt]="film.naslov" />
        </div>

        <div class="film-info-main">
          <h1 class="film-title-large">{{ film.naslov }}</h1>

          <div class="film-meta-large">
            <span class="meta-item">ğŸ“… {{ film.godina }}</span>
            <span class="separator">â€¢</span>
            <span class="meta-item">â±ï¸ {{ film.trajanjeMin }} min</span>
          </div>

          <div class="film-rating-large">
            <div class="rating-stars">
                <span class="stars-big">â­ {{ getProsecnaOcena().toFixed(1) }}</span>
                <span class="rating-count-big">({{ getBrojOcena() }} ocena)</span>
              </div>
              <div class="comments-count">
                <span>ğŸ’¬ {{ getBrojKomentara() }} komentara</span>
              </div>
            </div>

            <div class="film-zanrovi-large">
              <h3>Å½anrovi:</h3>
              <div class="zanr-list">
                <span *ngFor="let zanr of film.zanr" class="zanr-badge-large">{{ zanr }}</span>
              </div>
            </div>

            @if (film.reziser && film.reziser.length > 0) {
              <div class="film-reziser">
                <h3>ReÅ¾iser{{ film.reziser.length > 1 ? 'i' : '' }}:</h3>
                <div class="reziser-info">
                  <a *ngFor="let rez of film.reziser"
                     [routerLink]="['/reziser', rez]"
                     class="reziser-badge">
                    ğŸ¬ {{ rez }}
                  </a>
                </div>
              </div>
            }

            <div class="film-glumci">
              <h3>Glumci:</h3>
              <div class="glumci-list">
                <a
                  *ngFor="let glumac of film.glumci"
                  [routerLink]="['/glumac', glumac]"
                  class="glumac-badge">
                  {{ glumac }}
                </a>
              </div>
            </div>
          </div>
          </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button
            class="btn-favorite"
            [class.active]="isFavorite"
            [disabled]="!isLoggedIn"
            (click)="toggleFavorite()">
            <span class="icon">{{ isFavorite ? 'â¤ï¸' : 'ğŸ¤' }}</span>
            <span class="text">{{ isFavorite ? 'U Favoritima' : 'Dodaj u Favorite' }}</span>
          </button>

          @if (!isLoggedIn) {
            <span class="login-hint">ğŸ’¡ Prijavi se da dodaÅ¡ filmove u favorite</span>
          }
        </div>

        <!-- Rating Statistics Section -->
        <div class="rating-section">
          <h3>â­ Ocene</h3>

          <div class="rating-stats-display">
            <div class="stat-item">
              <span class="stat-label">ProseÄna ocena:</span>
              <span class="stat-value">{{ getProsecnaOcena() > 0 ? getProsecnaOcena().toFixed(2) : 'N/A' }} â­</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ukupno ocena:</span>
              <span class="stat-value">{{ getBrojOcena() }}</span>
            </div>
          </div>

          @if (isLoggedIn && !hasUserRated) {
            <div class="rating-widget">
              <span class="label">Oceni ovaj film:</span>
              <div class="stars-rating">
                @for (star of [1,2,3,4,5]; track star) {
                  <button
                    class="star-btn"
                    [class.active]="star <= userRating"
                    (click)="rateFilm(star)">
                    â­
                  </button>
                }
              </div>
            </div>
          } @else if (isLoggedIn && hasUserRated) {
            <div class="user-rating-display">
              <span class="label">Tvoja ocena:</span>
              <span class="rating-value">{{ userRating }} â­</span>
            </div>
          } @else {
            <span class="login-hint">ğŸ’¡ Prijavi se da oceniÅ¡ film</span>
          }
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
          <h3>ğŸ’¬ Komentari</h3>

          @if (isLoggedIn) {
            <div class="comment-form">
              <textarea
                [(ngModel)]="newComment"
                placeholder="NapiÅ¡i komentar..."
                rows="3"
                [disabled]="submittingComment">
              </textarea>
              <button
                class="btn-submit-comment"
                (click)="submitComment()"
                [disabled]="submittingComment || !newComment.trim()">
                {{ submittingComment ? 'Å aljem...' : 'Dodaj komentar' }}
              </button>
            </div>
          } @else {
            <span class="login-hint">ğŸ’¡ Prijavi se da ostaviÅ¡ komentar</span>
          }

          <!-- Display existing comments -->
          @if (film.komentari && film.komentari.length > 0) {
            <div class="comments-list">
              @for (comment of film.komentari; track comment) {
                <div class="comment-item">
                  <div class="comment-header">
                    <span class="comment-author">{{ comment.korisnik }}</span>
                    <span class="comment-date">{{ comment.datum | date: 'dd.MM.yyyy HH:mm' }}</span>
                  </div>
                  <p class="comment-text">{{ comment.tekst }}</p>
                </div>
              }
            </div>
          } @else {
            <p class="no-comments">JoÅ¡ nema komentara za ovaj film.</p>
          }
        </div>

        <!-- Availability and Rent Section -->
        <div class="availability-section">
          <div class="availability-info">
            <h3>ğŸ“¦ Dostupnost i cena</h3>
            <div class="stock-info">
              <span class="stock-label">Ukupno primeraka:</span>
              <span class="stock-value">{{ film.ukupnoKomada }}</span>
            </div>
            <div class="stock-info">
              <span class="stock-label">Dostupno za iznajmljivanje:</span>
              <span class="stock-value" [class.out-of-stock]="!isFilmAvailable()">
                {{ availableCount }}
              </span>
            </div>
            <div class="stock-info price-info">
              <span class="stock-label">ğŸ’° Cena iznajmljivanja (1 dan):</span>
              <span class="stock-value price-value">{{ film.cenaDnevno }} RSD</span>
            </div>

            @if (isFilmAvailable()) {
              <div class="availability-status available">
                âœ… Film je dostupan
              </div>
            } @else {
              <div class="availability-status unavailable">
                âŒ Svi primerci su trenutno iznajmljeni
              </div>
            }
          </div>

            <button
            class="btn-rent"
            [disabled]="!isLoggedIn || !isFilmAvailable() || rentingInProgress"
            (click)="rentFilm()">
            @if (rentingInProgress) {
              <span class="spinner-small"></span>
              <span>ObraÄ‘ujem...</span>
            } @else {
              <span class="icon">ğŸ¬</span>
              <span>Iznajmi Film</span>
            }
            </button>

          @if (!isLoggedIn) {
            <span class="login-hint-rent">ğŸ’¡ Prijavi se da iznajmiÅ¡ film</span>
          }
        </div>

        <!-- Metadata Section -->
        @if (film.produkcija || film.budzet || film.boxOffice || film.jezik || film.titlovi) {
          <div class="metadata-section">
            <h2>ğŸ“‹ Dodatne informacije</h2>
            <div class="metadata-grid">
              @if (film.produkcija) {
                <div class="metadata-item">
                  <span class="metadata-label">ğŸ¬ Produkcija:</span>
                  <span class="metadata-value">{{ film.produkcija }}</span>
                </div>
              }
              @if (film.budzet) {
                <div class="metadata-item">
                  <span class="metadata-label">ğŸ’° BudÅ¾et:</span>
                  <span class="metadata-value">{{ film.budzet }}</span>
                </div>
              }
              @if (film.boxOffice) {
                <div class="metadata-item">
                  <span class="metadata-label">ğŸ’µ Box Office:</span>
                  <span class="metadata-value">{{ film.boxOffice }}</span>
                </div>
              }
              @if (film.jezik) {
                <div class="metadata-item">
                  <span class="metadata-label">ğŸŒ Jezik:</span>
                  <span class="metadata-value">{{ film.jezik }}</span>
                </div>
              }
              @if (film.titlovi && film.titlovi.length > 0) {
                <div class="metadata-item">
                  <span class="metadata-label">ğŸ“ Titlovi:</span>
                  <span class="metadata-value">
                    <span *ngFor="let titl of film.titlovi; let last = last">
                      {{ titl }}<span *ngIf="!last">, </span>
                    </span>
                  </span>
                </div>
              }
            </div>
          </div>
        }

      <!-- Film Description -->
      <div class="film-description">
        <h2>ğŸ“– Opis filma</h2>
        <p>{{ film.opis }}</p>
      </div>

        <!-- Trailer Section -->
        @if (film.trailerUrl) {
          <div class="trailer-section">
            <h2>ğŸ¥ Trailer</h2>
            <app-video-player
              [trailerUrl]="film.trailerUrl"
              [filmNaslov]="film.naslov">
            </app-video-player>
          </div>
        }

        <!-- AI Recommendations Section (KNN Algorithm) -->
        <div class="recommendations-section">
          <h2>ğŸ¤– SliÄni filmovi <span class="ai-badge">AI Powered</span></h2>
          <p class="recommendations-subtitle">
            PronaÄ‘eno pomoÄ‡u KNN algoritma na osnovu Å¾anrova
          </p>

          @if (recommendationsLoading) {
            <div class="recommendations-loading">
              <div class="spinner"></div>
              <p>Analiziram sliÄne filmove...</p>
          </div>
          } @else if (similarFilms.length > 0) {
            <div class="similar-films-grid">
              @for (similarFilm of similarFilms; track similarFilm._id) {
                <div class="similar-film-card" (click)="navigateToFilm(similarFilm._id!)">
                  <div class="film-poster">
                    <img [src]="similarFilm.poster" [alt]="similarFilm.naslov">
          </div>
                  <div class="film-info">
                    <h3>{{ similarFilm.naslov }}</h3>
                    <p class="film-year">{{ similarFilm.godina }}</p>
                    <div class="film-genres">
                      @for (zanr of similarFilm.zanr.slice(0, 2); track zanr) {
                        <span class="genre-badge">{{ zanr }}</span>
                      }
          </div>
                    <div class="film-rating">
                      <span class="rating-value">
                        â­ {{ getAverageRating(similarFilm) > 0 ? getAverageRating(similarFilm).toFixed(1) : 'N/A' }}
                      </span>
                      <span class="rating-count">({{ similarFilm.ocene.length }})</span>
        </div>
      </div>
    </div>
              }
      </div>
          } @else {
            <div class="no-recommendations">
              <p>Trenutno nema dovoljno filmova za preporuke.</p>
    </div>
          }
      </div>

      </div>
    }

    <!-- Modal za iznajmljivanje -->
    @if (showRentalModal) {
      <div class="modal-overlay" (click)="closeRentalModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>ğŸ“… Iznajmljivanje filma</h2>
            <button class="btn-close-modal" (click)="closeRentalModal()">âœ–</button>
          </div>
          <div class="modal-body">
            <div class="film-info-modal">
              <img [src]="film?.poster" [alt]="film?.naslov" class="poster-small" />
              <div class="info">
                <h3>{{ film?.naslov }}</h3>
                <p>ğŸ’° Cena: {{ film?.cenaDnevno }} RSD / dan</p>
              </div>
            </div>
            <div class="form-group">
              <label for="startDate">ğŸ“… Datum poÄetka iznajmljivanja:</label>
              <input
                type="date"
                id="startDate"
                class="date-input"
                [(ngModel)]="rentalStartDate"
                [min]="minStartDate"
                (change)="onStartDateChange()"
                required />
              <small class="hint">Minimum: sutra ({{ formatDateDisplay(minStartDate) }})</small>
            </div>
            <div class="form-group">
              <label for="endDate">ğŸ“… Datum kraja iznajmljivanja:</label>
              <input
                type="date"
                id="endDate"
                class="date-input"
                [(ngModel)]="rentalEndDate"
                [min]="minEndDate"
                [disabled]="!rentalStartDate"
                (change)="onEndDateChange()"
                required />
              <small class="hint" *ngIf="rentalStartDate">
                Minimum: {{ formatDateDisplay(minEndDate) }} (dan nakon poÄetka)
              </small>
              <small class="hint" *ngIf="!rentalStartDate">
                Prvo izaberite datum poÄetka
              </small>
            </div>
            <!-- Polje za kreditnu karticu -->
            <div class="form-group">
              <label for="cardNumber">ğŸ’³ Broj kreditne kartice:</label>
              <div class="card-input-wrapper">
                <input
                  type="text"
                  id="cardNumber"
                  class="card-input"
                  [class.valid]="isCardValid"
                  [class.invalid]="cardNumber.length >= 15 && !isCardValid"
                  [(ngModel)]="cardNumber"
                  (input)="onCardNumberInput()"
                  placeholder="Unesite broj kartice"
                  maxlength="16"
                  required />
                <!-- Ikonica tipa kartice -->
                @if (cardType) {
                  <div class="card-icon">
                    @if (cardType === 'visa') {
                      <span class="card-badge visa-badge">VISA</span>
                    }
                    @if (cardType === 'mastercard') {
                      <span class="card-badge mastercard-badge">MasterCard</span>
                    }
                    @if (cardType === 'diners') {
                      <span class="card-badge diners-badge">Diners</span>
                    }
                  </div>
                }
              </div>
              <!-- Validaciona poruka -->
              @if (cardNumber.length > 0 && cardNumber.length < 15) {
                <small class="hint">Unesite kompletan broj kartice</small>
              }
              @if (cardNumber.length >= 15 && !isCardValid) {
                <small class="error-hint">âŒ NevaÅ¾eÄ‡i broj kartice</small>
              }
              @if (isCardValid) {
                <small class="success-hint">âœ… VaÅ¾eÄ‡i {{ cardType === 'visa' ? 'Visa' : cardType === 'mastercard' ? 'MasterCard' : 'Diners' }} broj</small>
              }
              <small class="info-hint">
                PrihvaÄ‡amo: Visa, MasterCard, Diners Club
              </small>
            </div>
            @if (totalDays > 0 && totalPrice > 0) {
              <div class="rental-summary">
                <h4>ğŸ“‹ Rezime iznajmljivanja:</h4>
                <div class="summary-item">
                  <span>Broj dana:</span>
                  <strong>{{ totalDays }} {{ totalDays === 1 ? 'dan' : 'dana' }}</strong>
                </div>
                <div class="summary-item">
                  <span>Cena po danu:</span>
                  <strong>{{ film?.cenaDnevno }} RSD</strong>
                </div>
                <div class="summary-item total">
                  <span>Ukupna cena:</span>
                  <strong>{{ totalPrice }} RSD</strong>
                </div>
              </div>
            }
            <!-- Prikaz rezultata iznajmljivanja -->
            <div *ngIf="rentalResultMessage" [ngClass]="{'rental-result-message': true, 'error': rentalResultError}">
              {{ rentalResultMessage }}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeRentalModal()">
              OtkaÅ¾i
            </button>
            <button
              class="btn-confirm"
              [disabled]="!rentalStartDate || !rentalEndDate || !isCardValid || totalDays < 1 || rentingInProgress"
              (click)="confirmRental()">
              @if (rentingInProgress) {
                <span class="spinner-small"></span>
                <span>ObraÄ‘ujem...</span>
              } @else {
                <span>âœ… Potvrdi iznajmljivanje</span>
              }
            </button>
          </div>
        </div>
      </div>
    }

  </div>
</div>
